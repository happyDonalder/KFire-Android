<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>NuGet API v3 Test Page</title>
    <link rel="stylesheet" type="text/css" href="/content/site.css">
    <link rel="stylesheet" type="text/css" href="/content/json2htmlstyle.css">
    <script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.js"></script>
    <script src="/content/json2html.js"></script>
    <script>

        var currentBlob;    // for debugging
        var currentHtml;

        var numberWithCommas = function (x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        var makePackageHtml = function (p) {

            var html = '';

            var lastUpdated = new Date(p.details.lastUpdated);
            var statsDate = lastUpdated.getFullYear() + '/' + (lastUpdated.getMonth() + 1) + '/' + lastUpdated.getDate();

            html += '<div id="sideColumn">';
            html += '<img class="logo" src="' + p.details.iconUrl + '" alt="Icon for package ' + p.title + '" /> ';

            html += '<div id="stats">';
            html += '    <div class="stat">';
            html += '        <p class="stat-number">' + numberWithCommas(p.downloads) + '</p>';
            html += '        <p class="stat-label">';
            html += '            Downloads</p>';
            html += '    </div>';
            html += '    <div class="stat">';
            html += '        <p class="stat-number">' + numberWithCommas(p.details.downloads) + '</p>';
            html += '        <p class="stat-label">';
            html += '            Downloads of ' + p.details.version + '</p>';
            html += '    </div>';
            html += '    <div class="stat">';
            html += '        <p class="stat-number">' + statsDate + '</p>';
            html += '        <p class="stat-label">';
            html += '            Last update</p>';
            html += '    </div>';
            html += '</div>';
            html += '</div>';

            html += '<div id="mainColumn" role="main">';

            if (p.details.prerelease) {
                html += '<p><em>This is prerelease version of ' + p.details.title + '</em></p>';
            }

            html += '<hgroup class="page-heading">';
            html += '    <h1>' + p.details.title + '</h1>';
            html += '    <h2>' + p.details.version + '</h2>';
            html += '</hgroup>';

            html += '<p>' + p.details.description + '</p>';

            if (p.details.copyright !== null) {
                html += '<h3>Copyright: ' + p.details.copyright + '</h3>';
            }

            if (p.details.releaseNotes !== null) {
                html += '<h3>Release Notes</h3>';
                var releaseNotes = p.details.releaseNotes.split('\n');
                for (var i = 0; i < releaseNotes.length; i += 1) {
                    html += '<p>' + releaseNotes[i] + '</p>';
                }
            }

            html += '<h3>Owners</h3>';
            html += '<ul class="owners">';
            for (var i = 0; i < p.owners.length; i += 1) {
                var o = p.owners[i];
                html += '<li><a class="owner" href="' + o.uri + '">' + o.userName + '</a></li>';
            }
            html += '</ul>';

            html += '<h3>Authors</h3>';
            html += '<p>';
            for (var i = 0; i < p.details.authors.length; i += 1) {
                html += p.details.authors[i] + ' ';
            }
            html += '</p>';

            if (p.details.tags.length > 0) {
                html += '<h3>Tags</h3>';
                html += '<p>';
                for (var i = 0; i < p.details.tags.length; i += 1) {
                    html += p.details.tags[i] + ' ';
                }
                html += '</p>';
            }

            html += '<h3>Dependencies</h3>';
            if (p.details.dependsOn.length > 0) {
                html += '<ul class="dependencySet">';
                for (var i = 0; i < p.details.dependsOn.length; i += 1) {
                    var d = p.details.dependsOn[i];
                    html += '<li><a class="package" href="' + d.uri + '">' + d.id + '</a> <span>' + d.displayVersionSpec + '</span></li>';
                }
                html += '</ul>';
            }
            else {
                html += '<p>This package has no dependencies.</p>';
            }

            html += '<h3>Content</h3>';

            //TEMP HACK
            var contentUrl = location.protocol + '//' + location.host + '/api/v3/packagecontent/' + p.details.id + '/' + p.details.version + '/';

            html += '<a class="packagecontent" href="' + contentUrl + '">Show</a>';
            html += '<div id="displaypackagecontent"></div>';

            html += '<h3>Version History</h3>';
            html += '<table class="sexy-table">';
            html += '<thead><tr><th class="first">Version</th><th>Downloads</th><th class="last">Last Updated</th></tr></thead>';
            html += '<tbody>';

            var days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

            for (var i = 0; i < p.versions.length; i += 1) {
                var v = p.versions[i];
                var versionLastUpdated = new Date(p.versions[i].lastUpdated);
                var versionDate = days[versionLastUpdated.getDay()] + ', ' + months[versionLastUpdated.getMonth()] + ' ' + versionLastUpdated.getDate() + ' ' + versionLastUpdated.getFullYear();

                html += '<tr class="versionTableRow';
                if (i === 0) {
                    html += ' recommended ';
                }
                html += '">';
                html += '<td><a class="package" href="' + v.uri + '">' + p.details.id + ' ' + v.version + '</a></td>';
                html += '<td>' + v.downloads + '</td>';
                html += '<td>' + versionDate + '</td>';
                html += '</tr>';
            }

            html += '</tbody>';
            html += '</table>';
            html += '</div>';

            return html;
        }

        var makeOwnerHtml = function (o) {

            var html = '';

            html += '<div id="sideColumn">';
            html += '    <div id="stats">';
            html += '        <div class="stat">';
            html += '            <p class="stat-number">' + o.packages.length + '</p>';
            html += '            <p class="stat-label">Packages</p>';
            html += '        </div>';
            html += '        <div class="stat">';
            html += '            <p class="stat-number">' + numberWithCommas(o.downloads) + '</p>';
            html += '            <p class="stat-label">Downloads of ' + o.userName + '\'s packages</p>';
            html += '        </div>';
            html += '    </div>';
            html += '</div>';

            html += '<div id="mainColumn" role="main">';
            html += '<h1>' + o.userName + '\'s Profile</h1>';
            html += '<h2>Packages</h2>';
            html += '<ul id="searchResults">';
            for (var i = 0; i < o.packages.length; i += 1) {
                html += '<li>';
                html += '<section class="package">';
                html += '<div class="side">';
                html += '    <a class="package" href="' + o.packages[i].uri + '" title="">';
                html += '        <img src="' + o.packages[i].iconUrl + '" />';
                html += '    </a>';
                html += '</div>';
                html += '<div class="main">';
                html += '    <h1><a class="package" href="' + o.packages[i].uri + '">' + o.packages[i].title + '</a></h1>';
                html += '    <p>' + o.packages[i].description + '</p>';
                html += '    <footer><p class="downloads">' + numberWithCommas(o.packages[i].downloads) + ' downloads</p></footer>';
                html += '</div>';
                html += '</section>';
                html += '</li>';
            }
            html += '</ul>';
            html += '</div>';

            return html;
        }

        //  debug
        var makeQueryString = function (data)
        {
            var html = '';
            for (var name in data) {
                var value = data[name];
                html += '<h3>' + name + '</h3>';
                html += '<ul>';
                for (var i = 0; i < value.length; i += 1) {
                    html += '<li>' + value[i] + '</li>';
                }
                html += '</ul>';
            }
            return html;
        }

        var makeSearchResultsHtml = function (results) {
            var html = '';
            html += '<h1>Search Results</h1>';
            html += '<ol id="searchResults">';
            for (var i = 0; i < results.length; i += 1) {
                html += '<li>';
                html += '<section class="package">';
                html += '  <div class="side">';
                html += '    <a class="package" href="' + results[i].uri + '">';
                html += '      <img src="' + results[i].iconUrl + '">';
                html += '    </a>';
                html += '  </div>';
                html += '  <div class="main">';
                html += '    <header>';
                html += '      <h1><a class="package" href="' + results[i].uri + '">' + results[i].title + '</a><h1>';
                html += '      <h2>By:</h2>';
                html += '      <ul class="owners">';

                for (var j = 0; j < results[i].owners.length; j += 1) {
                    var owner = results[i].owners[j];
                    html += '<li>';
                    html += '<a class="owner" href="' + owner.uri + '" title="' + owner.userName + '">' + owner.userName + '</a> ';
                    html += '</li>';
                }

                html += '      </ul>';
                html += '    </header>';
                html += '    <p>' + results[i].description + '</p>';
                html += '    <footer>';
                html += '      <p class="downloads">' + numberWithCommas(results[i].downloads) + ' downloads</p>';
                html += '      <div class="tags">';
                html += '        <h2>Tags</h2>';
                html += '        <ul class="tags">';

                for (var j = 0; j < results[i].tags.length; j += 1) {
                    var tag = results[i].tags[j];
                    html += '<li>';
                    html += tag + ' ';
                    html += '</li>';
                }

                html += '        </ul>';
                html += '      </div>';
                html += '    </footer>';
                html += '  </div>';
                html += '</section>';
                html += '</li>';
            }
            html += '</ol>';
            return html;
        }

        var packagecontentLink = function (e) {
            e.preventDefault();
            var url = $(this).attr('href');

            $.ajax({
                url: url,
                cache: false,
                success: function (data, textStatus) {

                    var html = '';

                    html += '<ul>';
                    for (var i = 0; i < data.length; i += 1) {
                        html += '<li>' + data[i] + '</li>';
                    }
                    html += '</ul>';

                    $('#displaypackagecontent').html(html);
                }
            });
        }

        var showCurrentHtml = function () {
            $('#result').html(currentHtml);
            $('a.package').click(packageLink);
            $('a.owner').click(ownerLink);
            $('a.packagecontent').click(packagecontentLink);
        }

        var showCurrentBlobSize = function () {
            $("#size").html(JSON.stringify(currentBlob).length.toString());
        }

        var fetchAndDisplay = function (url, makeHtml) {
            $("#url").html('<em>' + url + '</url>');
            $.ajax({
                url: url,
                cache: false,
                success: function (data, textStatus) {
                    currentBlob = data;
                    if (makeHtml) {
                        currentHtml = makeHtml(data);
                        showCurrentHtml();
                    }
                    else {
                        currentHtml = '<em>HTML view is now unavailable because navigation was done from JSON view and so we no longer know the "type" (try searching again.)</em>';
                        showJson();
                    }
                    showCurrentBlobSize();
                }
            });
        }

        var packageLink = function (e) {
            e.preventDefault();
            fetchAndDisplay($(this).attr('href'), makePackageHtml);
        }

        var ownerLink = function (e) {
            e.preventDefault();
            fetchAndDisplay($(this).attr('href'), makeOwnerHtml);
        }

        var packageFetch = function (e) {
            var packageName = $('#packageName').val();
            var isPackageRegistration = (packageName.split('/').length === 1);
            var url = location.protocol + '//' + location.host + '/api/v3/package/' + packageName + '/';
            fetchAndDisplay(url, makePackageHtml);
            return false;
        }

        var searchFetch = function (e) {
            var q = $('#q').val();
            var url = location.protocol + '//' + location.host + '/api/v3/search?q=' + q;
            fetchAndDisplay(url, makeSearchResultsHtml);
            return false;
        }

        var json2htmlLink = function (e) {
            e.preventDefault();
            var url = $(this).attr('href');
            if (url.indexOf('api/v3') > -1) {
                fetchAndDisplay($(this).attr('href'));
            }
        }

        var showJson = function () {
            var html = '';
            //html += '<pre>';
            //html += JSON.stringify(currentBlob, null, 2);
            //html += '</pre>';
            html = json2html(currentBlob);
            $('#result').html(html);
            $('a.json2html').click(json2htmlLink);
        }

        var showHtml = function () {
            showCurrentHtml();
        }

        $(document).ready(function () {
            $('#packageForm').submit(packageFetch);
            $('#searchForm').submit(searchFetch);
            $('#showJson').click(showJson);
            $('#showHtml').click(showHtml);
        });
    </script>
</head>
<body>
    <div id="url" class="banner-yellow">
        This is an internal test environment for API v3.
    </div>
    <p>
        <div style="float:left;padding-left:10px">
            <form id="packageForm">
                Package:
                    <input id="packageName" placeholder="Id/Version" type="text" />
                    <input type="submit" value="GO" />
            </form>
        </div>
        <div style="float:left;padding-left:10px">
            <button id="showJson" type="button">JSON</button>
            <button id="showHtml" type="button">HTML</button>
        </div>
        <div style="float:left;padding-left:10px">
            <i>Blob Size: <span id="size">0</span></i>
        </div>
    </p>
    <nav class="main">
        <div id="searchBox" role="search">
            <form id="searchForm">
                <input id="q" placeholder="Search Packages" value="" />
                <input type="submit" value="GO" />
            </form>
        </div>
    </nav>
    <div id="result">
    </div>
</body>
</html>
